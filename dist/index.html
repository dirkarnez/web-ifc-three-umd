<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" type="image/png" href="./favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IFC.js</title>
  </head>
  <body>
    <div id="input-container">
      <input readonly type="file" id="openFileDialog" />
      <!-- <div>
        <label for="useFragment"> Use fragments </label>
        <input type="checkbox" id="useFragment" />
      </div> -->
    </div>
    <canvas id="threeCanvas"></canvas>
    <p style="padding-left: 150px;">Hello World</p>
    <a id ="test-button" class="button4" style="background-color:#a79e1cef">TEST</a>
    <script src="./bundle.min.js"></script>
    <script>
      const { 
      IFCLOCALPLACEMENT, IfcLocalPlacement,
      IFCDIRECTION, IfcDirection,
      IFCAXIS2PLACEMENT3D, IfcAxis2Placement3D,
      IFCAXIS2PLACEMENT2D, IfcAxis2Placement2D,
      IFCCIRCLEPROFILEDEF, IfcCircleProfileDef,
      IfcProfileTypeEnum,
      IFCEXTRUDEDAREASOLID, IfcExtrudedAreaSolid,
      IFCCARTESIANPOINT, IfcCartesianPoint,
      IFCCOLUMN, IfcColumn } = window.WebIFCThree.WebIFC;
      const ifcManager = window.WebIFCThree.createScene(document.getElementById('threeCanvas'));
      const ifcAPI = ifcManager.ifcLoader.ifcManager.ifcAPI;

      const doStuff = () => {
        
      

     let modelID = ifcAPI.CreateModel();
    /** */
    let EID = 1;

    function real(v/*: number*/)
    {
        return { type: 4, value: v}
    }

    function ref(v/*: number*/)
    {
        return { type: 5, value: v}
    }

    function empty()
    {
        return { type: 6}
    }

    function str(v/*: string*/)
    {
        return { type: 1, value: v}
    }

    function enm(v/*: string*/)
    {
        return { type: 3, value: v}
    }

    function makePt(x, y, z) {
        return {
            x: x/*: number*/, 
            y: y/*number*/,
            z: z/*number*/
        }
    }

    function makePt2D(x, y) {
        return {
            x: x/*: number*/, 
            y: y/*number*/
        }
    }

    function Point(model/*: number*/, api/*: IfcAPI*/, o/*: pt*/)
    {
        let ID = EID++;
        let pt = new IfcCartesianPoint(ID, 
                        IFCCARTESIANPOINT, 
                        [real(o.x), real(o.y), real(o.z)]);
        api.WriteLine(model, pt);
        return ref(ID);
    }

    function ExtrudedAreaSolid(modelID, ifcAPI, pos/*: pt*/, dir/*: pt*/, rad/*: number*/, len/*: number*/)
    {
        let ID = EID++;
        let pt = new IfcExtrudedAreaSolid(ID, 
                        IFCEXTRUDEDAREASOLID,
                        CircleProfile(model, api, rad, { x: 0, y: 0 }),
                        AxisPlacement(model, api, pos),
                        Dir(model, api, dir),
                        real(len));
        api.WriteLine(model, pt);
        return ref(ID);
    }

    function Dir(model/*: number*/, api/*: IfcAPI*/, o/*: pt*/)
    {
        let ID = EID++;
        let pt = new IfcDirection(ID, 
                        IFCDIRECTION, 
                        [real(o.x), real(o.y), real(o.z)]);
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function Point2D(model/*: number*/, api/*: IfcAPI*/, o/*: pt2D*/)
    {
        let ID = EID++;
        let pt = new IfcCartesianPoint(ID, 
                        IFCCARTESIANPOINT, 
                        [real(o.x), real(o.y)]);
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function AxisPlacement(model/*: number*/, api/*: IfcAPI*/, o/*: pt*/)
    {
        let locationID = Point(model, api, o);
        let ID = EID++;
        let pt = new IfcAxis2Placement3D(ID, 
                        IFCAXIS2PLACEMENT3D, 
                        locationID, 
                        empty(),
                        empty());
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function AxisPlacement2D(model/*: number*/, api/*: IfcAPI*/, o/*: pt2D*/)
    {
        let locationID = Point2D(model, api, o);
        let ID = EID++;
        let pt = new IfcAxis2Placement2D(ID, 
                        IFCAXIS2PLACEMENT2D,
                        locationID, 
                        empty());
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function Placement(model/*: number*/, api/*: IfcAPI*/, o/*: pt*/)
    {
        let axisID = AxisPlacement(model, api, o);
        let ID = EID++;
        let pt = new IfcLocalPlacement(ID, 
                        IFCLOCALPLACEMENT,
                        empty(),
                        axisID);
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function CircleProfile(model/*: number*/, api/*: IfcAPI*/, rad/*: number*/, o/*: pt2D*/)
    {
        let ID = EID++;
        let pt = new IfcCircleProfileDef(ID,
                        IFCCIRCLEPROFILEDEF,
                        enm(IfcProfileTypeEnum.AREA),
                        str('column-prefab'),
                        AxisPlacement2D(model, api, o),
                        real(rad));
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function ExtrudedAreaSolid(model/*: number*/, api/*: IfcAPI*/, pos/*: pt*/, dir/*: pt*/, rad/*: number*/, len/*: number*/)
    {
        let ID = EID++;
        let pt = new IfcExtrudedAreaSolid(ID, 
                        IFCEXTRUDEDAREASOLID,
                        CircleProfile(model, api, rad, { x: 0, y: 0 }),
                        AxisPlacement(model, api, pos),
                        Dir(model, api, dir),
                        real(len));
        api.WriteLine(model, pt);
        return ref(ID);
    }
    
    function StandardColumn(model/*: number*/, api/*: IfcAPI*/, pos/*: pt*/)
    {
        let shapeID = ExtrudedAreaSolid(model, api, 
            { x: -2, y: 0, z: -1 }, 
            { x: 0, y: 0, z: 1 },
            0.25,
            2);
    
        let ID = EID++;
        let pt = new IfcColumn(ID, 
                        IFCCOLUMN,
                        str("GUID"),
                        empty(),
                        str("name"),
                        empty(),
                        str("label"),
                        Placement(model, api, pos),
                        shapeID,
                        str("sadf"),
                        empty());
        api.WriteLine(model, pt);
        return ref(ID);
    }

    // https://tomvandig.github.io/web-ifc/examples/viewer/index.html
    StandardColumn(modelID, ifcAPI, makePt(0, 0, 0));
    
    let data = ifcAPI.ExportFileAsIFC(modelID);
      }
  debugger;

    // let content = new TextDecoder()
    // .decode(data)
    // .replace("FILE_SCHEMA(('IFC2X3'));", "FILE_SCHEMA(('IFC4'));");
    // console.log(content);
    // ifcAPI.CloseModel(modelID);
    // return ifcLoader.parse(new TextEncoder().encode(content));



      const input = document.querySelector('input[type="file"]');
      input.addEventListener('change', changed => {
        ifcManager
        .loadIFC(changed)
        .then(() => {
          console.log("loaded");
        })
      }, false);
    </script>
  </body>
</html>
